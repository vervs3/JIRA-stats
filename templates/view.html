{% extends "base.html" %}

{% block title %}Результаты анализа {{ data.display_timestamp }}{% endblock %}

{% block header %}Результаты анализа {{ data.display_timestamp }}{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h3>Сводная информация</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <th>Всего задач:</th>
                                        <td>{{ data.total_issues }}</td>
                                    </tr>
                                    {% if data.date_from or data.date_to %}
                                        <tr>
                                            <th>Период списания времени:</th>
                                            <td>
                                                {% if data.date_from and data.date_to %}
                                                    {{ data.date_from }} - {{ data.date_to }}
                                                {% elif data.date_from %}
                                                    от {{ data.date_from }}
                                                {% elif data.date_to %}
                                                    до {{ data.date_to }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endif %}
                                    {% if data.filter_id %}
                                        <tr>
                                            <th>ID фильтра:</th>
                                            <td>{{ data.filter_id }}</td>
                                        </tr>
                                    {% endif %}
                                    {% if data.jql_query %}
                                        <tr>
                                            <th>JQL запрос:</th>
                                            <td><code>{{ data.jql_query }}</code></td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            {% if data.summary %}
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <th>
                                                Количество проектов:
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.projects_count }}">ⓘ</i>
                                            </th>
                                            <td>{{ data.summary.projects_count }}</td>
                                        </tr>
                                        <tr>
                                            <th>
                                                Общая исходная оценка (часы):
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.total_original_estimate_hours }}">ⓘ</i>
                                            </th>
                                            <td>{{ "%.2f"|format(data.summary.total_original_estimate_hours|float) }}</td>
                                        </tr>
                                        <tr>
                                            <th>
                                                Общее затраченное время (часы):
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.total_time_spent_hours }}">ⓘ</i>
                                            </th>
                                            <td>{{ "%.2f"|format(data.summary.total_time_spent_hours|float) }}</td>
                                        </tr>
                                        <tr>
                                            <th>
                                                Средняя оценка на задачу (часы):
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.avg_estimate_per_issue }}">ⓘ</i>
                                            </th>
                                            <td>{{ "%.2f"|format(data.summary.avg_estimate_per_issue|float) }}</td>
                                        </tr>
                                        <tr>
                                            <th>
                                                Среднее затраченное время на задачу (часы):
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.avg_time_spent_per_issue }}">ⓘ</i>
                                            </th>
                                            <td>{{ "%.2f"|format(data.summary.avg_time_spent_per_issue|float) }}</td>
                                        </tr>
                                        <tr>
                                            <th>
                                                Общий коэффициент эффективности:
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.overall_efficiency }}">ⓘ</i>
                                            </th>
                                            <td>{{ "%.2f"|format(data.summary.overall_efficiency|float) }}</td>
                                        </tr>
                                        {% if data.summary.no_transitions_tasks_count is defined %}
                                        <tr>
                                            <th>
                                                Задачи без transitions (вероятно новые):
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="{{ data.tooltips.no_transitions_tasks_count }}">ⓘ</i>
                                            </th>
                                            <td>{{ data.summary.no_transitions_tasks_count }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if data.summary.open_tasks_count is defined %}
                                        <tr>
                                            <th>
                                                Открытые задачи с логированием времени:
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="Количество задач в статусе Open, на которые списано время за указанный период">ⓘ</i>
                                            </th>
                                            <td>{{ data.summary.open_tasks_count }}</td>
                                        </tr>
                                        {% endif %}
                                        {% if data.summary.open_tasks_time_spent_hours is defined %}
                                        <tr>
                                            <th>
                                                Затраченное время на открытые задачи (часы):
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="Суммарное время, списанное на задачи в статусе Open">ⓘ</i>
                                            </th>
                                            <td>{% if data.summary.open_tasks_time_spent_hours %}{{ "%.2f"|format(data.summary.open_tasks_time_spent_hours|float) }}{% else %}0.00{% endif %}</td>
                                        </tr>
                                        {% endif %}
                                        {% if data.summary.completed_tasks_no_comments_count is defined %}
                                        <tr>
                                            <th>
                                                Закрытые задачи без комментариев/вложений:
                                                <i class="bi bi-info-circle metric-info" data-bs-toggle="tooltip" title="Количество задач в статусах Resolved, Closed или Done, не имеющих комментариев или вложений">ⓘ</i>
                                            </th>
                                            <td>{{ data.summary.completed_tasks_no_comments_count }}</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Special charts section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Специальные графики</h3>
                </div>
                <div class="card-body">
                    <!-- Check for metrics or special charts -->
                    {% set has_open_tasks = data.charts and 'open_tasks' in data.charts %}
                    {% set has_no_comments = data.charts and 'completed_tasks_no_comments' in data.charts %}
                    {% set has_no_transitions = data.charts and 'no_transitions_tasks' in data.charts %}
                    {% set has_open_tasks_metrics = data.summary and (data.summary.open_tasks_count is defined or data.summary.open_tasks_time_spent_hours is defined) %}
                    {% set has_no_comments_metrics = data.summary and data.summary.completed_tasks_no_comments_count is defined %}
                    {% set has_no_transitions_metrics = data.summary and data.summary.no_transitions_tasks_count is defined %}
                    {% set show_section = has_open_tasks or has_no_comments or has_no_transitions or has_open_tasks_metrics or has_no_comments_metrics or has_no_transitions_metrics %}

                    {% if show_section %}
                        <div class="row">
                            <!-- Tasks without transitions (likely new) -->
                            {% if has_no_transitions or has_no_transitions_metrics or (data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.no_transitions) %}
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100 border-info">
                                    <div class="card-header bg-info text-white">
                                        <h4>Задачи без transitions (вероятно новые)</h4>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="text-muted mb-3">Задачи, которые никогда не меняли статус и, вероятно, всё еще находятся в начальном статусе</p>

                                        {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.no_transitions and data.chart_data.special_charts.no_transitions.total > 0 %}
                                            <div class="mb-2 small text-muted">Нажмите на столбец графика, чтобы открыть соответствующие задачи в Jira</div>
                                            <div class="chart-container">
                                                <div class="chart-canvas-wrapper">
                                                    <canvas id="noTransitionsChart" class="chart-canvas"></canvas>
                                                </div>
                                            </div>
                                        {% elif has_no_transitions and data.charts.no_transitions_tasks != 'placeholder' %}
                                            <img src="/charts/{{ data.charts.no_transitions_tasks }}" class="chart-img" alt="Задачи без transitions">
                                        {% else %}
                                            <div class="alert alert-info">
                                                {% if has_no_transitions_metrics and data.summary.no_transitions_tasks_count > 0 %}
                                                    <p>Визуализация графика недоступна, но найдено {{ data.summary.no_transitions_tasks_count }} задач без transitions.</p>
                                                {% else %}
                                                    <p>В анализируемый период задач без transitions не обнаружено.</p>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><strong>Всего задач:</strong>
                                                {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.no_transitions %}
                                                    {{ data.chart_data.special_charts.no_transitions.total }}
                                                {% else %}
                                                    {{ data.summary.no_transitions_tasks_count if data.summary and data.summary.no_transitions_tasks_count is defined else '0' }}
                                                {% endif %}
                                            </span>
                                            <span class="text-info"><i class="bi bi-info-circle"></i> Возможно, требуют внимания</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if has_open_tasks or has_open_tasks_metrics or (data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.open_tasks) %}
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100 border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h4>Открытые задачи с логированием времени</h4>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="text-muted mb-3">Задачи в статусе Open, на которые списано время за указанный период</p>

                                        {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.open_tasks and data.chart_data.special_charts.open_tasks.total > 0 %}
                                            <div class="mb-2 small text-muted">Нажмите на столбец графика, чтобы открыть соответствующие задачи в Jira</div>
                                            <div class="chart-container">
                                                <div class="chart-canvas-wrapper">
                                                    <canvas id="openTasksChart" class="chart-canvas"></canvas>
                                                </div>
                                            </div>
                                        {% elif has_open_tasks and data.charts.open_tasks != 'placeholder' %}
                                            <img src="/charts/{{ data.charts.open_tasks }}" class="chart-img" alt="Открытые задачи с логированием времени">
                                        {% else %}
                                            <div class="alert alert-info">
                                                {% if has_open_tasks_metrics and data.summary.open_tasks_count > 0 %}
                                                    <p>Визуализация графика недоступна, но найдено {{ data.summary.open_tasks_count }} открытых задач с логированием времени.</p>
                                                {% else %}
                                                    <p>В анализируемый период открытых задач с логированием времени не обнаружено.</p>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><strong>Всего задач:</strong>
                                                {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.open_tasks %}
                                                    {{ data.chart_data.special_charts.open_tasks.total }}
                                                {% else %}
                                                    {{ data.summary.open_tasks_count if data.summary and data.summary.open_tasks_count is defined else '0' }}
                                                {% endif %}
                                            </span>
                                            <span><strong>Затрачено времени:</strong>
                                                {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.open_tasks %}
                                                    {{ "%.2f"|format(data.chart_data.special_charts.open_tasks.total_time) }} ч.
                                                {% else %}
                                                    {{ "%.2f"|format(data.summary.open_tasks_time_spent_hours|float) if data.summary and data.summary.open_tasks_time_spent_hours is defined else '0.00' }} ч.
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {% if has_no_comments or has_no_comments_metrics or (data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.closed_no_comments) %}
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100 border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h4>Закрытые задачи без комментариев/вложений</h4>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="text-muted mb-3">Задачи в статусах Resolved, Closed или Done, не имеющие комментариев или вложений</p>

                                        {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.closed_no_comments and data.chart_data.special_charts.closed_no_comments.total > 0 %}
                                            <div class="mb-2 small text-muted">Нажмите на столбец графика, чтобы открыть соответствующие задачи в Jira</div>
                                            <div class="chart-container">
                                                <div class="chart-canvas-wrapper">
                                                    <canvas id="closedTasksChart" class="chart-canvas"></canvas>
                                                </div>
                                            </div>
                                        {% elif has_no_comments and data.charts.completed_tasks_no_comments != 'placeholder' %}
                                            <img src="/charts/{{ data.charts.completed_tasks_no_comments }}" class="chart-img" alt="Закрытые задачи без комментариев">
                                        {% else %}
                                            <div class="alert alert-info">
                                                {% if has_no_comments_metrics and data.summary.completed_tasks_no_comments_count > 0 %}
                                                    <p>Визуализация графика недоступна, но найдено {{ data.summary.completed_tasks_no_comments_count }} закрытых задач без комментариев и вложений.</p>
                                                {% else %}
                                                    <p>В анализируемый период закрытых задач без комментариев и вложений не обнаружено.</p>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><strong>Всего задач:</strong>
                                                {% if data.chart_data and data.chart_data.special_charts and data.chart_data.special_charts.closed_no_comments %}
                                                    {{ data.chart_data.special_charts.closed_no_comments.total }}
                                                {% else %}
                                                    {{ data.summary.completed_tasks_no_comments_count if data.summary and data.summary.completed_tasks_no_comments_count is defined else '0' }}
                                                {% endif %}
                                            </span>
                                            {% if data.summary and data.summary.completed_tasks_no_comments_count is defined and data.summary.completed_tasks_no_comments_count > 0 %}
                                                <span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> Требуют внимания</span>
                                            {% else %}
                                                <span class="text-success"><i class="bi bi-check-circle-fill"></i> Всё в порядке</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <h4 class="alert-heading">Нет специальных графиков</h4>
                            <p>В текущем отчете не найдены данные для специальных графиков:</p>
                            <ul>
                                <li><strong>Задачи без transitions</strong> - в анализируемый период нет задач, которые никогда не меняли статус.</li>
                                <li><strong>Открытые задачи с логированием времени</strong> - в анализируемый период нет задач в статусе Open, на которые было списано время.</li>
                                <li><strong>Закрытые задачи без комментариев/вложений</strong> - в анализируемый период нет закрытых задач без комментариев или вложений.</li>
                            </ul>
                            <hr>
                            <p class="mb-0">Это может быть хорошим признаком, так как отсутствие таких задач свидетельствует о том, что они либо закрываются своевременно, либо документируются должным образом.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <h3 class="mb-4">Графики</h3>

    <div class="row">
        {% if data.chart_data %}
            <!-- Interactive charts -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4>Распределение задач по проектам</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-2 small text-muted">Нажмите на столбец графика, чтобы открыть соответствующие задачи в Jira</div>
                        <div class="chart-container">
                            <div class="chart-canvas-wrapper">
                                <canvas id="projectDistributionChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4>Сравнение оценки и затраченного времени</h4>
                    </div>
                    <div class="card-body">
                        <div class="mb-2 small text-muted">Нажмите на столбец графика, чтобы открыть соответствующие задачи в Jira</div>
                        <div class="chart-container">
                            <div class="chart-canvas-wrapper">
                                <canvas id="comparisonChart" class="chart-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden JSON data for charts -->
            <script id="chart-data" type="application/json">
                {{ data.chart_data|tojson }}
            </script>

            <!-- Store filter params for JQL generation -->
            {% if data.date_from %}
            <span data-date-from="{{ data.date_from }}" style="display:none;"></span>
            {% endif %}
            {% if data.date_to %}
            <span data-date-to="{{ data.date_to }}" style="display:none;"></span>
            {% endif %}
            {% if data.filter_id %}
            <span data-base-jql="filter={{ data.filter_id }}" style="display:none;"></span>
            {% elif data.jql_query %}
            <span data-base-jql="{{ data.jql_query }}" style="display:none;"></span>
            {% endif %}
        {% else %}
            <!-- Static chart images if no interactive data -->
            {% for chart_type, chart_path in data.charts.items() %}
                <!-- Skip special charts already displayed in special section, and removed charts -->
                {% if chart_type != 'open_tasks' and chart_type != 'completed_tasks_no_comments' and chart_type != 'no_transitions_tasks' and chart_type != 'original_estimate' and chart_type != 'time_spent' %}
                <div class="col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            {% if chart_type == 'project_distribution' %}
                                <h4>Распределение задач по проектам</h4>
                            {% elif chart_type == 'comparison' %}
                                <h4>Сравнение оценки и затраченного времени</h4>
                            {% elif chart_type == 'project_pie' %}
                                <h4>Круговая диаграмма распределения задач</h4>
                            {% elif chart_type == 'efficiency' %}
                                <h4>Коэффициент эффективности</h4>
                            {% else %}
                                <h4>{{ chart_type|replace('_', ' ')|title }}</h4>
                            {% endif %}
                        </div>
                        <div class="card-body text-center">
                            <img src="/charts/{{ chart_path }}" class="chart-img" alt="{{ chart_type }}">
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </div>

    {% if data.chart_data and data.chart_data.projects|length > 0 %}
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4>Проекты и ссылки на Jira</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for project in data.chart_data.projects %}
                                <div class="col-md-3">
                                    <div class="clickable-box" onclick="createJiraLink('{{ project }}')">
                                        <strong>{{ project }}</strong>
                                        <div class="small text-muted">
                                            Задач: {{ data.chart_data.project_counts.get(project, 0) }}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    {% if not data.charts and not data.chart_data %}
        <div class="alert alert-warning">
            <p>Графики не найдены для этого анализа.</p>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
{% endblock %}